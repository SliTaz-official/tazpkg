#!/bin/sh
#
# List installed packages in a suitable format for GTK tree.
# List mirrored packages using the packages.desc file.
#

undigest_list()
{
	IFS="|"
	if [ -n "$1" -a "$1" != "all" ]; then
		cat /var/lib/tazpkg/undigest/$1/packages.desc
	else
		cat /var/lib/tazpkg/undigest/*/packages.desc
	fi 2> /dev/null | sort | while read PACKAGE VERSION SHORT_DESC; do
		ICON=tazpkg
		PACKAGE=${PACKAGE%% *}
		if [ -d /var/lib/tazpkg/installed/$PACKAGE ]; then
			ICON=tazpkg-installed
			if grep -qs "^$PACKAGE$" /var/lib/tazpkg/blocked-packages.list; then
				ICON=stop
			fi
		fi
		echo "$ICON|$PACKAGE|$VERSION|$SHORT_DESC"
	done
	unset IFS
}

installable_list()
{
	local cache
	cache=/var/lib/tazpkg/packages.installable_list.$CAT
	if [ -s $cache -a $cache -nt /var/lib/tazpkg/packages.desc \
	     -a $cache -nt /var/lib/tazpkg/installed ]; then
	     cat $cache
	     return
	fi
	IFS="|"
	cat /var/lib/tazpkg/packages.desc \
	    /var/lib/tazpkg/undigest/*/packages.desc 2> /dev/null | sort | \
	while read PACKAGE VERSION SHORT_DESC; do
		# Check first for category for more speed.
		CATEGORY=${CATEGORY%| *}
		ICON=tazpkg
		[ $CAT == all -o $CATEGORY == $CAT ] || continue
		[ -d /var/lib/tazpkg/installed/${PACKAGE%% *} ] && continue
		grep -qs "^$PACKAGE" /var/lib/tazpkg/undigest/*/packages.desc &&
			ICON=add
		echo "$ICON|$PACKAGE|$VERSION|$SHORT_DESC"
	done | tee $cache
	unset IFS
}

installed_list()
{
	for pkg in /var/lib/tazpkg/installed/*
	do
		. $pkg/receipt
		ICON=tazpkg-installed
		[ $CAT == all -o $CATEGORY == $CAT ] || continue
		grep -qs "^$PACKAGE" /var/lib/tazpkg/undigest/*/packages.desc &&
			ICON=add
		grep -qs "^$PACKAGE$" /var/lib/tazpkg/blocked-packages.list &&
			ICON=stop
		echo "$ICON|$PACKAGE|$VERSION|$SHORT_DESC"
	done
}

all_list()
{
	local cache
	cache=/var/lib/tazpkg/packages.all_list.$CAT
	if [ -s $cache -a $cache -nt /var/lib/tazpkg/packages.desc \
	     -a $cache -nt /var/lib/tazpkg/installed ]; then
	     cat $cache
	     return
	fi
	( installable_list ; installed_list ) | sort -t \| -k 2 -u | tee $cache
}

blocked_list()
{
	for pkg in $(cat /var/lib/tazpkg/blocked-packages.list 2> /dev/null); do
		[ -f /var/lib/tazpkg/installed/$pkg/receipt ] || continue
		. /var/lib/tazpkg/installed/$pkg/receipt
		AVAILABLE=$(grep -s "^$pkg " /var/lib/tazpkg/packages.desc \
			/var/lib/tazpkg/undigest/*/packages.desc | awk '{ print $3 }')
		echo "stop|$PACKAGE|$VERSION (Available: $AVAILABLE)|$SHORT_DESC"
	done
}

case $1 in
	all)
		STATUS=`cat /tmp/tazpkgbox/status`
		case $STATUS in
			blocked)
				blocked_list ;;
			installed)
				CAT=`cat /tmp/tazpkgbox/category`
				installed_list ;;
			installable)
				CAT=`cat /tmp/tazpkgbox/category`
				installable_list ;;
			*)
				CAT=`cat /tmp/tazpkgbox/category`
				all_list ;;
		esac ;;
	undigest)
		set -- `cat /tmp/tazpkgbox/undigest-category`
		if [ "$1" == "all" -o "$1" == "" ]; then
			undigest_list $2
		else
			undigest_list $2 | grep "$1"
		fi ;;
	blocked)
		blocked_list ;;
	*)
		echo "Usage: $0 [all|undigest|blocked]" ;;
esac

exit 0
